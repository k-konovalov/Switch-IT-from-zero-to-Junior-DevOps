# 01.03 Operation Systems - Работа с пакетным менеджером apt

## Теория
Отсутствует.

## 3.1 Установи с помощью apt (mc, zsh, htop, btop, netstat, net-tools).
Команды:
- для работы с дисками:
  - `df -h`: вывести информацию только о примонтированных файловых системах, включая те, которые не являются дисковыми разделами.
  - `lsblk`: выводит информацию о дисках и созданных на них разделах, их размерах, точке монтирования.
  - `blkid`: поиск или печать атрибутов диска
  - `parted -l`, `fdisk -l`: просмотреть размеры дисков и разделов.
- apt
  - Установка: `apt-get install prog_name`.
  - Переустановка: `apt-get reinstall prog_name` или `install --reinstall`
  - Удаление: `apt-get remove` / `apt-get purge` (с config фалами)

### mc
Midnight Commander: файловый менеджер с текстовым интерфейсом.

### Shell (Bourne again shell)
исполняемый файл: bash.
- Дефолт: оболочка есть в большинстве GNU/Linux дистро
- Лёгкая конфигурация и настройка: доступна в .bashrc в вашей домашней директории

#### Zsh (Z Shell)
- лучше автокомплит
- возможные значения после tab
- плагины
- темы

#### Fish «Friendly Interactive SHell»
- подсветка синтаксиса
- автоподсказки

### atop, btop, htop: Контроль нагрузки процессоров
- top:
  - предустановлена во всех дистрибутивах Linux и не требует отдельной установки;
- htop: интерактивный
- atop: отличается возможностью ведения логов.

#### top
В верхней части выводится информация о системе, ниже — список процессов. Вывод обновляется каждые 2 секунды.  
Самые «жадные» до ресурсов процессы, оказывающие самую большую нагрузку на процессор, будут выведены вверху списка.

**Сведения о системе**
Слева вверху указано текущее время системы, далее:
- Up — время работы системы с последнего запуска.
- User — количество текущих пользователей.
- Load average — средняя нагрузка на сервер: отображаются значения за одну, пять и 15 минут назад.
- Tasks — общее количество запущенных процессов в разных статусах (running — выполняемые; sleeping — в ожидании; stopped — остановленные; zombie — «зомби», дочерние процессы, ожидающие завершения родительского процесса).
- Cpu(s) — процент времени процессора, затраченного на выполнение процессов, в том числе:
  - us — пользовательские процессы (высокое значение данного показателя может указывать, в том числе, на проблемы в коде сайта, необходимость его оптимизации);
  - sy — процессы ядра;
  - id — неиспользуемые ресурсы (чем выше этот показатель, тем лучше);
  - wa — операции ввода/вывода, т.е. дисковые операции.
- Mem, Swap — сведения об использовании оперативной памяти (total — общий объем, free — объем свободной памяти, used — объем использованной памяти).

**Сведения о процессах**
По умолчанию процессы выстроены в таблице по размеру нагрузки на процессор, от большего значения к меньшему. Обозначения столбцов:
- PID — идентификатор процесса;
- USER — пользователь, запустивший процесс;
- PR — приоритет процесса;
- NI — измененный приоритет (присвоенный пользователем с помощью команды nice);
- VIRT — объем используемой виртуальной памяти (здесь выводится тот объем памяти, который был запрошен процессом, даже если фактически используется меньше);
- RES — объем используемой оперативной памяти (в данном случае, если процесс запросил 50Мб памяти, а использует 10Мб, будет выведено 10Мб);
- SHR — объем памяти, разделяемой с другими процессами (т.е.  память, которая может быть использована другими процессами);
- S — статус процесса (running — запущен; sleeping — в ожидании; zombie — процесс-«зомби»);
- %CPU — процент использования процессорного времени;
- %MEM — процент использования оперативной памяти;
- TIME — общее время работы процесса;
- COMMAND — имя процесса (команда, которой был запущен процесс).

### netstat / ss
Мониторинг сетевого сети: обзор сетевых соединений, таблиц маршрутизации, статистики интерфейсов и другой важной информации, связанной с сетью.
Часто используемые команды:
- -a: Показывает все прослушивающие порты и активные соединения
- -t: Отображает TCP-соединения
- -u: Показывает UDP-соединения
- -n: Показывает числовые адреса вместо разрешения хостов и портов
- -l: Показывает только прослушивающие сокеты
- -p: Отображает PID и имя программы
- -r: Показывает таблицу маршрутизации
- -i: Показывает статистику сетевых интерфейсов
- -s: Показывает статистику протоколов
- -c: непрерывное отображение (2 сек), комбинируетяс с другими командами (-ct) (но лучше через while с sleep)

### net-tools
Не нашел?

## 3.2 Добавление репозитория (Debian)
В Debian каждый репозиторий состоит из нескольких веток (разделов):

- main ― эта ветка включается в каждый дистрибутив. Она подчиняется принципам свободного программного обеспечения. Ветка не зависит от других пакетов, которые не входят в раздел «main»;
- contrib ― эта ветка подчиняется принципам свободного ПО и зависит только от пакетов, которые не входят в раздел «main». Может понадобиться прошивка ROM или ПО, которое имеет собственника, например Java от Oracle;
- non-free ― содержит пакеты, которые противоречат принципам свободного программного обеспечения или имеют патенты и другие юридические ограничения.

При добавлении надо знать текущий релиз и архитектуру процессора.
- `cat /etc/os-release | grep VERSION_CODENAME`: узнаем версию ОС
- `$(dpkg --print-architecture)`: узнаем архитектуру процессора

- Некоторые репозитории защищены ключами GPG или pkp
- Отредактировать файл `/etc/apt/sources.list`
- В конец файла вставить команду с адресом репозитория:
  - deb ― указывает на то, что это пакет Debian;
  - ссылка на репозиторий пакетов Debian (выглядит, как обычный URL-адрес сайта). На сайте Debian есть ссылки на зеркала, а также список сгруппированных пакетов, по категориям Stable, Testing, Unstable;
  - название версии Debian ― кодовое имя дистрибутива, псевдоним (например, Buster ― Debian 10, Stretch ― Debian 9, Jessie ― Debian 8, и т.д);
  - main ― тип ПО (main, contrib, non-free)
  - пример: `deb https://packages.debian.org/buster/libc6 buster main`
- Вызвать `apt-get update` для обновления пакетов
- Удаление производится таким же образом

Альтернативные варианты добавления:
- Вставить строку в `/etc/apt/sources.list` (основной)
  - `deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/elastic-7.x.gpg] https://artifacts.elastic.co/packages/7.x/apt stable main`
- Создание файла `.list` в `sources.list.d`
  - `echo "deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/elastic-7.x.gpg] https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list > /dev/null`
- Создание файла `.sources` в `sources.list.d`
  - `/etc/apt/sources.list.d/elastic-7.x.sources`
  - содержание файла:
  ```
  Types: deb
  Architectures: amd64 arm64
  Signed-By: /usr/share/keyrings/elastic-7.x.gpg
  URIs: https://artifacts.elastic.co/packages/7.x/apt
  Suites: stable
  Components: main
  ```

### Добавление стороннего репозитория (на примере Docker CE)
- нужно скачать GPG ключ
  - `sudo apt-get update`
  - `sudo apt-get install ca-certificates curl`: ставим нужные зависимости
  - `sudo install -m 0755 -d /etc/apt/keyrings`: создаем хранилище ключей
  - `sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc`: скачиваем gpg ключ
  - `sudo chmod a+r /etc/apt/keyrings/docker.asc`: открываем на чтение всем
- `cat /etc/os-release | grep VERSION_CODENAME`: узнаем версию ОС
- `$(dpkg --print-architecture)`: узнаем архитектуру процессора
- Добавил репозиторий
- `echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian bookworm stable" >> /etc/apt/sources.list`
  - deb: source использует обычную архитектуру Debian.
  - `arch=amd64,arm64`: архитектуры, на которые будут загружены данные APT. Здесь это amd64 и arm64.
  - `signed-by=/etc/apt/keyrings/docker.asc`: ключ, используемый для авторизации этого источника
  - `https://download.docker.com/linux/debian`: URI, репозитория
  - `/etc/apt/sources.list`: хранилище данных о репозиториях
- `sudo apt-get update`: обновляем

## Вопросы к ментору
- Мониторинг
  - Основной принцип: прочитать все что можно прочитать (CPU, RAM, Free disk) и сложить в одно место?
  - Что такое CPU Usage: Kernel?
  - Что используют чтобы дампить результаты htop?
  - Кроме CPU нужно смотреть еще RAM и свободное место? Чем? крона над df?

## Полезные ссылки
- Мониторинг
  - [htop и многое другое на пальцах](https://habr.com/ru/articles/316806/)
  - [Контроль нагрузки и процессов: top, htop, atop](https://timeweb.cloud/docs/unix-guides/troubleshooting-unix/load-and-process-control-top-htop-atop)
  - [Команда Linux blkid](https://linuxcookbook.ru/articles/komanda-linux-blkid)
  - [Осваиваем команду Linux Netstat: от основ до продвинутого мониторинга сети](https://go.lightnode.com/ru/tech/linux-netstat-command)
  - [Данные о дисках: df, lsblk, parted, fdisk](https://timeweb.cloud/docs/unix-guides/troubleshooting-unix/disk-data-df-lsblk-parted-fdisk)
- Зависимости
  - [Как добавить официальный репозиторий в Debian](https://help.reg.ru/support/servery-vps/oblachnyye-servery/ustanovka-programmnogo-obespecheniya/debian-repozitorii#3)
  - [Сторонние репозитории для Debian Stable](https://vk.com/@-53008948-storonnie-repozitorii-dlya-debian-stable)
  - [Как справиться с устареванием apt-key и add-apt-repository с помощью gpg в Ubuntu 22.04](https://habr.com/ru/articles/683716/)
  - [Install Docker using the apt repository](https://docs.docker.com/engine/install/debian/#install-using-the-repository)
  - [Install Docker Engine on Debian](https://docs.docker.com/engine/install/debian/)
