# 01.02 Operation Systems - Создание пользователя, добавление / убавление прав пользователей

## Теория
Отсутствует.

Одной из ключевых характеристик Linux является ее многопользовательская архитектура. Это означает, что на одном компьютере может существовать множество учетных записей.  
Каждая из них имеет свое собственное рабочее пространство, настройки и ресурсы. Благодаря этому пользователи получают возможность работать на одной машине одновременно, изолируя свои данные и деятельность друг от друга.

### Пользователь / группа

#### Типы пользователей
- Суперпользователь - неограниченные права (UID и GID у него равны специальному значению 0).
- Обычный пользователь - права с ограничениями, установленными для него суперпользователем. Имеют права на доступ в рамках своего идентификатора (UID, userid) и членства в группе (GID, group ID).
- Специальный пользователь - права с ограничениями, установленными ему суперпользователем для работы с конкретным приложением. Обычно различные системны службы.
- Псевдопользователь - нет никаких прав, он вообще не идентифицируется системой

#### Свойства пользователя
`account:password:UID:GID:GECOS:directory:shell`

- account — имя пользователя. Это поле не может быть пустым. Применяются стандартные для *NIX правила именования.
- password — пароль пользователя (или shadow пароль).
- UID — численное значение идентификатора пользователя. Нумерация обычных пользователей (отличных от root) обычно начинается с UID 100.
- GID — численное значение идентификатора основной группы пользователя. Идентификаторы групп можно найти в файле `/etc/group`.
- GECOS — необязательное поле, носящее информативный характер; обычно содержит настоящее имя пользователя, но может также использоваться службами вроде finger и изменяться командой chfn. Поскольку поле необязательное, его можно оставить пустым.
- directory — используется командой входа для задания переменной окружения $HOME. Некоторые службы, для которых создаются специальные пользователи, используют для этого корневой каталог /, но обычные пользователи чаще всего хранят домашний каталог в разделе /home.
- shell — командная оболочка пользователя. Это поле является необязательным, и если в нём ничего не указано, то используется оболочка /bin/bash.

#### Изменение настроек по умолчанию для новых пользователей
- `useradd -D`: просмотр текущих дефолтных настроек
- `useradd -D -b /home/WorkingProject -s /bin/bash`: изменение рабочей директории

#### Создание / удаление обычного пользователя
Необходимым и достаточным условием "существования" пользователя в системе является его наличие в файле `/etc/passwd`.
- через команду `adduser username`
- создается папка `/etc/home/` или в другом месте если переопределено дефолтное место
- добавляется запись в `/etc/passwd` или `/etc/shadow` с кешом пароля
- `userdel username`: удаление пользователя
  - -f — завершить все процессы пользователя и удалить насильно, даже если пользователь сейчас работает в системе;
  - -r — удалить домашний каталог пользователя;

#### Создание суперпользователя
- при установке всегда создается суперпользователь c именем root
- Установить команду sudo:
  - su -
  - `apt-get install sudo -y`
- чтобы предоставить обычному пользователю sudo-привилегии, его нужно добавить в группу sudo:
  - `usermod -aG sudo username`

#### Создание / удаление групп
Основные команды `groupadd`, `groupdel`, `groupmod`.
- gid — group id, номер группы.
- `cat /etc/group`: вывод существующих групп
- `groups пользователь`: вывод списка групп, в которых состоит пользователь
- `groupadd имя_группы`, `addgroup имя_группы`: создание группы
- `usermod -G имя_группы username`: добавление пользователя в группу
- `gpasswd -d пользователь группа`: удаление пользователя из группы ???
- `delgroup имя_группы`: удаление группы

### Права пользователей
Чтобы получить доступ к файлам в Linux, используются разрешения. Эти разрешения назначаются трем объектам: файлу, группе и всем остальным.  
В Linux у каждого файла и каждого каталога есть два владельца: пользователь и группа.
Владелец -> группа -> права других пользователей (other).

#### Все есть файл
Каждый файл принадлежит какому-то пользователю и группе. Существует три типа прав доступа — чтение, запись и исполнение.

#### Chown: смена владельца
- `chown кто что`: изменение владельца
  - `chown linda /home/account`: установить владельцем каталога пользователя linda
  - `chown -R linda /home/account`: установить владельца каталога и дочерних файлов / папок
- `chown .account /home/account`: Изменение владельца группы. Обязательно . или : перед названием группы.
  - `chown .sales myfile`:l устанавливает группу sales владельцем файла myfile без изменения владельца пользователя.
- ls -l: Эта команда показывает пользователя и группу-владельца.
- `find / -user linda`: получить список всех файлов в системе, в которых в качестве владельца указан данный пользователь или группа.
  - `find / -group users`: тоже самое, но для групп

#### Владелец по-умолчанию
Пользователь, который создает файл, автоматически становится владельцем этого файла, а основная группа этого пользователя автоматически становится владельцем этого файла.
Группа, которая ставится по-умолчанию, называется эффективная группа.
- `groups lisa`: посмотреть группы, к которому причастен пользователь
- `newgrp sales`: сменить эффективную группу

#### Основные права
- чтение: файл != каталог
  - файл: чтение содержимого
  - каталог: позволяет видеть содержимое, но не позволяет читать файлы в каталоге
- запись:
  - файл: изменять содержимое, но не создавать / менять права
  - каталог: создавать, удалять или задавать права
- выполнение: никогда не разрешено по умолчанию
  - файл: запустить файл как программу
  - каталог: перейти в каталог
- расширенные права: GUID, SUID, sticky bit (первый символ в 4х буквенном chmod)
  - SUID (4): разрешение на установку идентификатора пользователя
    - `chmod u+s`.
  - SGID (2): разрешения владельца группы на файл
    - `chmod g+s`.
    - пример: `chmod g+s somecatalog` все новые файлы в каталоге будут иметь группу каталога, а не пользователя.
  - GUID: идентификатор группы
  - sticky bit (1): защиты файлов от случайного удаления
- ACL: разрешения нескольким пользователям или группам в каталоге

#### chmod: Управление правами
При настройке разрешений рассчитывается необходимое значение для установки для user, group, other.
- Абсолютный режим: В абсолютном режиме три цифры используются для установки основных разрешений.
  - 4: Read
  - 2: Write
  - 1: Execute
- Относительный режим:
  - Можно установить сразу для всех пользователей: `chmod +x somefile`.
  - Либо для отдельных `chmod g+s somecatalog` или `chmod u+s somecatalog`

### Команды
- `su -l`: Start the shell as a login shell with an environment similar to a real login:
  - -l, --login
- `adduser user_01`
  - старая команда: `usradd`
  - useradd -D: просмотр текущих настреок пользователя
- `passwd user_01`: установка пароля пользователю. Без нее пользователь неактивен.
- `id username` получить инфу о пользователе
- `users` список пользователей
- Просмотр файла `/etc/passwd`, который содержит информацию о зарегистрированных в системе пользователях;
- `w`: подробный список активных юзеров, включая их имена, терминалы, активность (что они делают в данный момент), время входа и загруженность системы.
- `who` – показывает список активных пользователей, а также информацию о них;
- `last` – предоставляет историю входов пользователей, позволяя увидеть, когда и с каких устройств они входили в систему;
- `lastlog` – показывает информацию о последних входах пользователей, включая дату и время этих событий.
- `sed 's/:.*//' /etc/passwd`: список всех созданных пользователей
- `su - username`: переключение на пользователя

## Выполнение задания
1. Создай двух пользователей и общую папку между ними.
   1. Под рутом:
      1. `groupadd admins`: добавить новую группу
      2. `adduser user_01`: добавить пользователя
      3. `passwd user_01`: и задать ему пароль
      4. `usermod -G admins user_01`: добавление пользователя в созданную группу
      5. `mkdir ./tmp/shared`: создаем общую папку
      6. `chown :admins shared`: делаем ей группу admins
      7. chmod 770 shared: даем права на выполнение
      8. chmod g+s shared: созданные файлы наследуют владельца каталога, а не пользователя (SGID)
   2. Под пользователем:
      1. `newgrp admins`: сменить эффективную группу пользователя
      2. `touch file`: создаем файл в общей папке
      3. `chmod 660 file`: даем разрешение на запись всем в группе
2. Оба пользователя должны уметь читать и писать в эту папку
   1. Повторить для другого пользователя

## Вопросы к ментору
Отсутствуют.

## Полезные ссылки
- Пользователь: добавление, удаление, права
  - [Arch Linux | User and Groups](https://wiki.archlinux.org/title/Users_and_groups_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9))
  - [Как посмотреть пользователей в Linux](https://timeweb.cloud/tutorials/linux/kak-posmotret-polzovatelej-v-linux)
  - [Общие папки Linux](https://losst.pro/obshhie-papki-linux)
- Группы
  - [Arch Linux | Группы](https://wiki.archlinux.org/title/Users_and_groups_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)#%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%B3%D1%80%D1%83%D0%BF%D0%BF)
  - [Habr | Права в Linux](https://habr.com/ru/articles/469667/)
